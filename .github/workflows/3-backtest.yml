name: 3. Automated Backtest

on:
  push:
    branches: [ master ]
    paths:
      - 'user_data/strategies/**'
      - 'config/config.json'
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      timerange:
        description: 'Timerange for backtest (e.g., 20240101-20241231)'
        required: false
        default: '20250101-20250331'
      strategy:
        description: 'Strategy to test'
        required: false
        default: 'FreqAIHybridStrategy'

jobs:
  backtest:
    name: Run Backtest
    runs-on: self-hosted
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-
          
    - name: Pull Freqtrade Docker Image
      run: |
        echo "üì• Pulling Freqtrade Docker image..."
        docker pull freqtradeorg/freqtrade:stable_freqairl
        
    - name: Download historical data (sample)
      run: |
        echo "üìä Downloading sample data for backtest..."
        docker run --rm \
          -v ${{ github.workspace }}/user_data:/freqtrade/user_data \
          freqtradeorg/freqtrade:stable_freqairl \
          download-data \
          --exchange binance \
          --pairs BTC/USDT:USDT ETH/USDT:USDT \
          --timeframes 5m 15m 1h \
          --days 720 \
          --trading-mode futures \
          --data-format-ohlcv feather
      continue-on-error: true
        
    - name: Run backtest
      id: backtest
      run: |
        echo "üöÄ Running backtest..."
        
        TIMERANGE="${{ github.event.inputs.timerange || '20241001-20250101' }}"
        STRATEGY="${{ github.event.inputs.strategy || 'FreqAIHybridStrategy' }}"
        
        docker run --rm \
          -v ${{ github.workspace }}/user_data:/freqtrade/user_data \
          -v ${{ github.workspace }}/config:/freqtrade/config \
          freqtradeorg/freqtrade:stable_freqairl \
          backtesting \
          --strategy ${STRATEGY} \
          --strategy-path /freqtrade/user_data/strategies \
          --config /freqtrade/config/config.json \
          --freqaimodel LightGBMRegressorMultiTarget \
          --timerange ${TIMERANGE} \
          --export trades \
          --export-filename user_data/backtest_results/backtest-result-${GITHUB_SHA:0:7}.json \
          2>&1 | tee backtest_output.txt
      continue-on-error: true
    
    - name: Set up Python for monitoring tools
      uses: actions/setup-python@v4
      with:
        python-version: '3.11.5'
        cache: 'pip'
        update-environment: true
        
    - name: Install monitoring dependencies
      run: |
        pip install pandas numpy PyYAML
        
    - name: Extract metrics from backtest
      id: extract-metrics
      run: |
        echo "üìä Extracting metrics from backtest output..."
        
        if [ -f backtest_output.txt ]; then
          python monitoring/extract_metrics.py backtest_output.txt
        else
          echo "‚ö†Ô∏è Backtest output not found, skipping metrics extraction"
        fi
      continue-on-error: true
        
    - name: Run governance decision
      id: governance
      run: |
        echo "üõ°Ô∏è Running governance decision engine..."
        
        if [ -f monitoring/latest_metrics.json ]; then
          python monitoring/governance_decider.py \
            --policy config/governance_policy.yaml \
            --latest monitoring/latest_metrics.json \
            --history monitoring/metrics_history.csv \
            --out monitoring/governance_decisions.jsonl
          
          # Extract governance status for output
          if [ -f monitoring/governance_decisions.jsonl ]; then
            LAST_DECISION=$(tail -n 1 monitoring/governance_decisions.jsonl)
            STATUS=$(echo $LAST_DECISION | python -c "import sys, json; print(json.load(sys.stdin).get('status', 'unknown'))")
            RISK_MULT=$(echo $LAST_DECISION | python -c "import sys, json; print(json.load(sys.stdin).get('actions', {}).get('risk_multiplier', '1.0'))")
            
            echo "governance_status=${STATUS}" >> $GITHUB_OUTPUT
            echo "risk_multiplier=${RISK_MULT}" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Governance decision: ${STATUS} (risk: ${RISK_MULT}x)"
          fi
        else
          echo "‚ö†Ô∏è Metrics not available, skipping governance decision"
          echo "governance_status=unavailable" >> $GITHUB_OUTPUT
        fi
      continue-on-error: true
    
    - name: Parse backtest results
      id: parse-results
      run: |
        echo "üìä Parsing backtest results..."
        
        # Extract key metrics from output
        if [ -f backtest_output.txt ]; then
          TOTAL_TRADES=$(grep -oP "Total\/Daily Avg Trades.*?(\d+)" backtest_output.txt | grep -oP "\d+" | head -1 || echo "N/A")
          WIN_RATE=$(grep -oP "Win.*?(\d+\.?\d*)%" backtest_output.txt | grep -oP "\d+\.?\d*" | head -1 || echo "N/A")
          PROFIT=$(grep -oP "Total profit.*?(\d+\.?\d*)%" backtest_output.txt | grep -oP "\d+\.?\d*" | head -1 || echo "N/A")
          
          echo "total_trades=${TOTAL_TRADES}" >> $GITHUB_OUTPUT
          echo "win_rate=${WIN_RATE}" >> $GITHUB_OUTPUT
          echo "profit=${PROFIT}" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload backtest results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backtest-results-${{ github.sha }}
        path: |
          backtest_output.txt
          user_data/backtest_results/
          monitoring/latest_metrics.json
          monitoring/metrics_history.csv
          monitoring/governance_decisions.jsonl
        retention-days: 30
        
    - name: Create performance badge
      if: always()
      run: |
        mkdir -p .github/badges
        
        PROFIT="${{ steps.parse-results.outputs.profit }}"
        if [ "$PROFIT" != "N/A" ]; then
          COLOR="green"
          if (( $(echo "$PROFIT < 0" | bc -l) )); then
            COLOR="red"
          elif (( $(echo "$PROFIT < 5" | bc -l) )); then
            COLOR="yellow"
          fi
          
          echo "![Profit](https://img.shields.io/badge/Profit-${PROFIT}%25-${COLOR})" > .github/badges/profit.md
        fi
        
    - name: Generate backtest summary
      if: always()
      run: |
        echo "## üìä Backtest Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Strategy:** ${{ github.event.inputs.strategy || 'FreqAIHybridStrategy' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timerange:** ${{ github.event.inputs.timerange || '20241001-20250101' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Trades:** ${{ steps.parse-results.outputs.total_trades || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Win Rate:** ${{ steps.parse-results.outputs.win_rate || 'N/A' }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Profit:** ${{ steps.parse-results.outputs.profit || 'N/A' }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üõ°Ô∏è Governance Status" >> $GITHUB_STEP_SUMMARY
        
        GOV_STATUS="${{ steps.governance.outputs.governance_status || 'unavailable' }}"
        RISK_MULT="${{ steps.governance.outputs.risk_multiplier || '1.0' }}"
        
        if [ "$GOV_STATUS" == "halt" ]; then
          echo "- **Status:** üõë **HALT** - New entries blocked" >> $GITHUB_STEP_SUMMARY
        elif [ "$GOV_STATUS" == "degrade" ]; then
          echo "- **Status:** ‚ö†Ô∏è **DEGRADE** - Risk reduced to ${RISK_MULT}x" >> $GITHUB_STEP_SUMMARY
        elif [ "$GOV_STATUS" == "warn" ]; then
          echo "- **Status:** ‚ö†Ô∏è **WARN** - Risk adjusted to ${RISK_MULT}x" >> $GITHUB_STEP_SUMMARY
        elif [ "$GOV_STATUS" == "none" ] || [ "$GOV_STATUS" == "resume" ]; then
          echo "- **Status:** ‚úÖ **NORMAL** - All systems operational" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Status:** ‚ÑπÔ∏è Governance check unavailable" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "üì• Full results and governance decisions available in artifacts" >> $GITHUB_STEP_SUMMARY
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const totalTrades = '${{ steps.parse-results.outputs.total_trades }}';
          const winRate = '${{ steps.parse-results.outputs.win_rate }}';
          const profit = '${{ steps.parse-results.outputs.profit }}';
          const govStatus = '${{ steps.governance.outputs.governance_status }}';
          const riskMult = '${{ steps.governance.outputs.risk_multiplier }}';
          
          let govEmoji = '‚ÑπÔ∏è';
          let govMessage = 'Governance check unavailable';
          
          if (govStatus === 'halt') {
            govEmoji = 'üõë';
            govMessage = '**HALT** - New entries blocked due to risk thresholds';
          } else if (govStatus === 'degrade') {
            govEmoji = '‚ö†Ô∏è';
            govMessage = `**DEGRADE** - Risk reduced to ${riskMult}x, shorts disabled`;
          } else if (govStatus === 'warn') {
            govEmoji = '‚ö†Ô∏è';
            govMessage = `**WARN** - Risk adjusted to ${riskMult}x`;
          } else if (govStatus === 'none' || govStatus === 'resume') {
            govEmoji = '‚úÖ';
            govMessage = '**NORMAL** - All systems operational';
          }
          
          const body = `## ü§ñ Automated Backtest Results
          
          ### Performance Metrics
          - **Total Trades:** ${totalTrades}
          - **Win Rate:** ${winRate}%
          - **Total Profit:** ${profit}%
          
          ### ${govEmoji} Governance Status
          ${govMessage}
          
          ### Configuration
          - **Strategy:** FreqAIHybridStrategy
          - **Timerange:** ${{ github.event.inputs.timerange || '20241001-20250101' }}
          - **Commit:** \`${{ github.sha }}\`
          
          üì• Download full results and governance decisions from the workflow artifacts.
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
