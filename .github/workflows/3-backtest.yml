name: 3. Automated Backtest

on:
  push:
    branches: [ master ]
    paths:
      - 'user_data/strategies/**'
      - 'config/config.json'
  pull_request:
    branches: [ master ]
  workflow_dispatch:
    inputs:
      timerange:
        description: 'Timerange for backtest (e.g., 20240101-20241231)'
        required: false
        default: '20241001-20250101'
      strategy:
        description: 'Strategy to test'
        required: false
        default: 'FreqAIHybridStrategy'

jobs:
  backtest:
    name: Run Backtest
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Free Disk Space
      run: |
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf "/usr/local/share/boost"
        sudo rm -rf "$AGENT_TOOLSDIRECTORY"
        df -h
        
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      
    - name: Cache Docker layers
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-
          
    - name: Pull Freqtrade Docker Image
      run: |
        echo "ðŸ“¥ Pulling Freqtrade Docker image..."
        docker pull freqtradeorg/freqtrade:stable_freqairl
        
    - name: Download historical data (sample)
      run: |
        echo "ðŸ“Š Downloading sample data for backtest..."
        docker run --rm \
          -v ${{ github.workspace }}/user_data:/freqtrade/user_data \
          freqtradeorg/freqtrade:stable_freqairl \
          download-data \
          --exchange binance \
          --pairs BTC/USDT:USDT ETH/USDT:USDT \
          --timeframes 5m 15m 1h \
          --days 90 \
          --trading-mode futures \
          --data-format-ohlcv feather
      continue-on-error: true
        
    - name: Run backtest
      id: backtest
      run: |
        echo "ðŸš€ Running backtest..."
        
        TIMERANGE="${{ github.event.inputs.timerange || '20241001-20250101' }}"
        STRATEGY="${{ github.event.inputs.strategy || 'FreqAIHybridStrategy' }}"
        
        docker run --rm \
          -v ${{ github.workspace }}/user_data:/freqtrade/user_data \
          -v ${{ github.workspace }}/config:/freqtrade/config \
          freqtradeorg/freqtrade:stable_freqairl \
          backtesting \
          --strategy ${STRATEGY} \
          --strategy-path /freqtrade/user_data/strategies \
          --config /freqtrade/config/config.json \
          --freqaimodel LightGBMRegressorMultiTarget \
          --timerange ${TIMERANGE} \
          --export trades \
          --export-filename user_data/backtest_results/backtest-result-${GITHUB_SHA:0:7}.json \
          2>&1 | tee backtest_output.txt
      continue-on-error: true
        
    - name: Parse backtest results
      id: parse-results
      run: |
        echo "ðŸ“Š Parsing backtest results..."
        
        # Extract key metrics from output
        if [ -f backtest_output.txt ]; then
          TOTAL_TRADES=$(grep -oP "Total\/Daily Avg Trades.*?(\d+)" backtest_output.txt | grep -oP "\d+" | head -1 || echo "N/A")
          WIN_RATE=$(grep -oP "Win.*?(\d+\.?\d*)%" backtest_output.txt | grep -oP "\d+\.?\d*" | head -1 || echo "N/A")
          PROFIT=$(grep -oP "Total profit.*?(\d+\.?\d*)%" backtest_output.txt | grep -oP "\d+\.?\d*" | head -1 || echo "N/A")
          
          echo "total_trades=${TOTAL_TRADES}" >> $GITHUB_OUTPUT
          echo "win_rate=${WIN_RATE}" >> $GITHUB_OUTPUT
          echo "profit=${PROFIT}" >> $GITHUB_OUTPUT
        fi
        
    - name: Upload backtest results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backtest-results-${{ github.sha }}
        path: |
          backtest_output.txt
          user_data/backtest_results/
        retention-days: 30
        
    - name: Create performance badge
      if: always()
      run: |
        mkdir -p .github/badges
        
        PROFIT="${{ steps.parse-results.outputs.profit }}"
        if [ "$PROFIT" != "N/A" ]; then
          COLOR="green"
          if (( $(echo "$PROFIT < 0" | bc -l) )); then
            COLOR="red"
          elif (( $(echo "$PROFIT < 5" | bc -l) )); then
            COLOR="yellow"
          fi
          
          echo "![Profit](https://img.shields.io/badge/Profit-${PROFIT}%25-${COLOR})" > .github/badges/profit.md
        fi
        
    - name: Generate backtest summary
      if: always()
      run: |
        echo "## ðŸ“Š Backtest Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration" >> $GITHUB_STEP_SUMMARY
        echo "- **Strategy:** ${{ github.event.inputs.strategy || 'FreqAIHybridStrategy' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Timerange:** ${{ github.event.inputs.timerange || '20241001-20250101' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Results" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Trades:** ${{ steps.parse-results.outputs.total_trades || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Win Rate:** ${{ steps.parse-results.outputs.win_rate || 'N/A' }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Total Profit:** ${{ steps.parse-results.outputs.profit || 'N/A' }}%" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ Full results available in artifacts" >> $GITHUB_STEP_SUMMARY
        
    - name: Comment PR with results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const totalTrades = '${{ steps.parse-results.outputs.total_trades }}';
          const winRate = '${{ steps.parse-results.outputs.win_rate }}';
          const profit = '${{ steps.parse-results.outputs.profit }}';
          
          const body = `## ðŸ¤– Automated Backtest Results
          
          ### Performance Metrics
          - **Total Trades:** ${totalTrades}
          - **Win Rate:** ${winRate}%
          - **Total Profit:** ${profit}%
          
          ### Configuration
          - **Strategy:** FreqAIHybridStrategy
          - **Timerange:** ${{ github.event.inputs.timerange || '20241001-20250101' }}
          - **Commit:** \`${{ github.sha }}\`
          
          ðŸ“¥ Download full results from the workflow artifacts.
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
