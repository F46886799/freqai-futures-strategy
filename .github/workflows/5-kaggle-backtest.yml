name: üöÄ Kaggle GPU Backtest (Automated)

on:
  push:
    branches: [master]
    paths:
      - 'user_data/strategies/**'
      - 'config/config.json'
      - '.github/workflows/5-kaggle-backtest.yml'
  workflow_dispatch:
    inputs:
      timerange:
        description: 'Timerange for backtest (e.g., 20250101-20251012)'
        required: false
        default: '20250101-20251012'
      pairs:
        description: 'Trading pairs (space separated)'
        required: false
        default: 'BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT'

jobs:
  kaggle-backtest:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: üì¶ Install Kaggle CLI
        run: |
          pip install kaggle
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
      
      - name: üìã Create Kaggle Kernel Metadata
        run: |
          cat > kernel-metadata.json << 'EOF'
          {
            "id": "${{ secrets.KAGGLE_USERNAME }}/freqai-futures-strategy-backtest",
            "title": "freqai-futures-strategy-backtest",
            "code_file": "kaggle_backtest.py",
            "language": "python",
            "kernel_type": "script",
            "is_private": true,
            "enable_gpu": true,
            "enable_internet": true,
            "dataset_sources": [],
            "competition_sources": [],
            "kernel_sources": []
          }
          EOF
      
      - name: üîß Create Kaggle Backtest Script
        run: |
          cat > kaggle_backtest.py << 'EOFPY'
          #!/usr/bin/env python3
          """
          FreqAI Backtest Script for Kaggle GPU
          Auto-generated by GitHub Actions
          """
          import os
          import sys
          import subprocess
          from datetime import datetime
          
          print("=" * 60)
          print("üöÄ FreqAI Backtest on Kaggle")
          print("=" * 60)
          
          # Check GPU availability
          print("\nüìä Checking GPU...")
          try:
              result = subprocess.run(["nvidia-smi"], capture_output=True, text=True, check=False)
              if result.returncode == 0:
                  print("‚úÖ GPU Available!")
                  print(result.stdout[:500])  # First 500 chars
              else:
                  print("‚ö†Ô∏è GPU command failed, using CPU")
          except FileNotFoundError:
              print("‚ö†Ô∏è nvidia-smi not found - Running on CPU")
          except Exception as e:
              print(f"‚ö†Ô∏è GPU check failed: {e} - Running on CPU")
          
          # Install dependencies
          print("\nüì¶ Installing dependencies...")
          subprocess.run([
              sys.executable, "-m", "pip", "install", 
              "freqtrade[freqai]", "ta-lib-binary", 
              "--quiet"
          ], check=True)
          
          # Clone repository
          print("\nüì• Cloning repository...")
          repo_url = "https://github.com/aminak58/freqai-futures-strategy.git"
          subprocess.run(["git", "clone", repo_url, "project"], check=True)
          os.chdir("project")
          
          # Download data
          print("\nüíæ Downloading historical data...")
          timerange = os.getenv("TIMERANGE", "20250101-20251012")
          pairs = os.getenv("PAIRS", "BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT")
          
          download_cmd = [
              "freqtrade", "download-data",
              "--exchange", "binance",
              "--pairs"] + pairs.split() + [
              "--timeframes", "5m", "15m", "1h",
              "--days", "365",
              "--trading-mode", "futures",
              "--config", "config/config.json"
          ]
          subprocess.run(download_cmd, check=True)
          
          # Run backtest
          print("\nüß™ Running backtest with FreqAI...")
          backtest_cmd = [
              "freqtrade", "backtesting",
              "--strategy", "FreqAIHybridStrategy",
              "--config", "config/config.json",
              "--freqaimodel", "LightGBMRegressorMultiTarget",
              "--timerange", timerange,
              "--export", "trades"
          ]
          
          result = subprocess.run(backtest_cmd, capture_output=True, text=True)
          print(result.stdout)
          if result.stderr:
              print("‚ö†Ô∏è Errors:", result.stderr)
          
          # Parse results
          print("\nüìä Backtest Results:")
          if result.returncode == 0:
              print("‚úÖ Backtest completed successfully!")
              # Look for results file
              import json
              try:
                  with open("user_data/backtest_results/backtest-result.json") as f:
                      data = json.load(f)
                      if "strategy" in data:
                          stats = data["strategy"]["FreqAIHybridStrategy"]
                          print(f"\nüí∞ Total Profit: {stats.get('profit_total_abs', 'N/A')}")
                          print(f"üìà Profit %: {stats.get('profit_total', 'N/A')}%")
                          print(f"üìä Sharpe Ratio: {stats.get('sharpe', 'N/A')}")
                          print(f"üìâ Max Drawdown: {stats.get('max_drawdown', 'N/A')}%")
                          print(f"üéØ Win Rate: {stats.get('wins', 'N/A')}")
                          print(f"üî¢ Total Trades: {stats.get('total_trades', 'N/A')}")
              except Exception as e:
                  print(f"‚ö†Ô∏è Could not parse results: {e}")
          else:
              print("‚ùå Backtest failed!")
              sys.exit(1)
          
          print("\n" + "=" * 60)
          print("‚úÖ Kaggle backtest completed at", datetime.now())
          print("=" * 60)
          EOFPY
      
      - name: üöÄ Push to Kaggle & Run
        env:
          TIMERANGE: ${{ github.event.inputs.timerange || '20250101-20251012' }}
          PAIRS: ${{ github.event.inputs.pairs || 'BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT' }}
        run: |
          echo "üì§ Pushing kernel to Kaggle..."
          kaggle kernels push -p .
          
          echo "‚è≥ Waiting for kernel to start..."
          sleep 10
          
          echo "üìä Checking kernel status..."
          kaggle kernels status ${{ secrets.KAGGLE_USERNAME }}/freqai-futures-strategy-backtest || echo "Status check failed (kernel may still be queued)"
          
          echo "‚úÖ Kernel submitted! Check results at:"
          echo "https://www.kaggle.com/code/${{ secrets.KAGGLE_USERNAME }}/freqai-futures-strategy-backtest"
      
      - name: üìù Create Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## üöÄ Kaggle Backtest Triggered
          
          **‚è∞ Time:** $(date)
          **üåø Branch:** ${{ github.ref_name }}
          **üíæ Commit:** ${{ github.sha }}
          
          ###  üìä Parameters:
          - **Timerange:** ${{ github.event.inputs.timerange || '20250101-20251012' }}
          - **Pairs:** ${{ github.event.inputs.pairs || 'BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT' }}
          
          ### üîó Links:
          - [üìà View Results on Kaggle](https://www.kaggle.com/code/${{ secrets.KAGGLE_USERNAME }}/freqai-futures-strategy-backtest)
          - [üìú Kernel Output](https://www.kaggle.com/code/${{ secrets.KAGGLE_USERNAME }}/freqai-futures-strategy-backtest/output)
          
          > ‚ö†Ô∏è Note: Kaggle kernels may take 5-10 minutes to start. Check the link above for real-time progress.
          EOF
