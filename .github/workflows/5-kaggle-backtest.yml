name: ğŸš€ Kaggle GPU Backtest (Automated)

on:
  push:
    branches: [master]
    paths:
      - 'user_data/strategies/**'
      - 'config/config.json'
      - '.github/workflows/5-kaggle-backtest.yml'
  workflow_dispatch:
    inputs:
      timerange:
        description: 'Timerange for backtest (e.g., 20250101-20251012)'
        required: false
        default: '20250101-20251012'
      pairs:
        description: 'Trading pairs (space separated)'
        required: false
        default: 'BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT'

jobs:
  kaggle-backtest:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
      
      - name: ğŸ“¦ Install Kaggle CLI
        run: |
          pip install kaggle
          mkdir -p ~/.kaggle
          echo '{"username":"${{ secrets.KAGGLE_USERNAME }}","key":"${{ secrets.KAGGLE_KEY }}"}' > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
      
      - name: ğŸ“‹ Create Kaggle Kernel Metadata (NOTEBOOK with GPU)
        run: |
          cat > kernel-metadata.json << 'EOF'
          {
            "id": "${{ secrets.KAGGLE_USERNAME }}/freqai-gpu-backtest",
            "title": "FreqAI GPU Backtest",
            "code_file": "backtest.ipynb",
            "language": "python",
            "kernel_type": "notebook",
            "is_private": true,
            "enable_gpu": true,
            "enable_tpu": false,
            "enable_internet": true,
            "dataset_sources": [],
            "competition_sources": [],
            "kernel_sources": []
          }
          EOF
      
      - name: ğŸ““ Create Kaggle Notebook (GPU-REQUIRED)
        env:
          TIMERANGE: ${{ github.event.inputs.timerange || '20250101-20251012' }}
          PAIRS: ${{ github.event.inputs.pairs || 'BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT' }}
        run: |
          cat > backtest.ipynb << 'EOFNB'
          {
            "cells": [
              {
                "cell_type": "markdown",
                "metadata": {},
                "source": ["# ğŸš€ FreqAI GPU Backtest\n", "**REQUIRES GPU!** Please enable: Runtime â†’ Change runtime type â†’ GPU (T4)"]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": [
                  "# âœ… GPU VERIFICATION - Will FAIL if no GPU!\n",
                  "import subprocess\n",
                  "print('ğŸ” Checking for GPU...')\n",
                  "try:\n",
                  "    result = subprocess.run(['nvidia-smi'], capture_output=True, text=True, check=True)\n",
                  "    print('âœ… GPU AVAILABLE!')\n",
                  "    print(result.stdout)\n",
                  "except Exception as e:\n",
                  "    print('âŒ GPU NOT FOUND!')\n",
                  "    print('Please enable GPU: Runtime â†’ Change runtime type â†’ GPU')\n",
                  "    raise RuntimeError('GPU is REQUIRED for this backtest!') from e"
                ]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": ["!pip install -q freqtrade[freqai] ta-lib-binary"]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": [
                  "!git clone https://github.com/aminak58/freqai-futures-strategy.git project\n",
                  "%cd project"
                ]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": [
                  "import os\n",
                  "timerange = os.getenv('TIMERANGE', '20250101-20251012')\n",
                  "pairs = os.getenv('PAIRS', 'BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT')\n",
                  "print(f'â° Timerange: {timerange}')\n",
                  "print(f'ğŸ’± Pairs: {pairs}')"
                ]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": [
                  "!freqtrade download-data \\\n",
                  "    --exchange binance \\\n",
                  "    --pairs $PAIRS \\\n",
                  "    --timeframes 5m 15m 1h \\\n",
                  "    --days 365 \\\n",
                  "    --trading-mode futures \\\n",
                  "    --config config/config.json"
                ]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": [
                  "# ğŸš€ GPU-ACCELERATED BACKTEST\n",
                  "!freqtrade backtesting \\\n",
                  "    --strategy FreqAIHybridStrategy \\\n",
                  "    --config config/config.json \\\n",
                  "    --freqaimodel LightGBMRegressorMultiTarget \\\n",
                  "    --timerange $TIMERANGE \\\n",
                  "    --export trades"
                ]
              },
              {
                "cell_type": "code",
                "execution_count": null,
                "metadata": {},
                "outputs": [],
                "source": [
                  "# ğŸ“Š Display Results\n",
                  "import json\n",
                  "from pathlib import Path\n",
                  "\n",
                  "results_file = Path('user_data/backtest_results/backtest-result.json')\n",
                  "if results_file.exists():\n",
                  "    with open(results_file) as f:\n",
                  "        data = json.load(f)\n",
                  "        if 'strategy' in data:\n",
                  "            stats = data['strategy']['FreqAIHybridStrategy']\n",
                  "            print('\\n' + '='*60)\n",
                  "            print('ğŸ“ˆ RESULTS')\n",
                  "            print('='*60)\n",
                  "            print(f\"ğŸ’° Profit: {stats.get('profit_total_abs', 'N/A')} USDT ({stats.get('profit_total', 'N/A')}%)\")\n",
                  "            print(f\"ğŸ“Š Sharpe: {stats.get('sharpe', 'N/A')}\")\n",
                  "            print(f\"ğŸ“‰ Drawdown: {stats.get('max_drawdown', 'N/A')}%\")\n",
                  "            print(f\"ğŸ¯ Trades: {stats.get('total_trades', 'N/A')}\")\n",
                  "            print('='*60)\n",
                  "else:\n",
                  "    print('âŒ Results file not found!')"
                ]
              }
            ],
            "metadata": {
              "kernelspec": {"display_name": "Python 3", "language": "python", "name": "python3"}
            },
            "nbformat": 4,
            "nbformat_minor": 4
          }
          EOFNB
      
      - name: ğŸš€ Push to Kaggle (GPU ENABLED)
        run: |
          echo "ğŸ“¤ Pushing notebook to Kaggle with GPU..."
          kaggle kernels push -p .
          
          echo "â³ Waiting for kernel to queue..."
          sleep 10
          
          echo "ğŸ“Š Checking status..."
          kaggle kernels status ${{ secrets.KAGGLE_USERNAME }}/freqai-gpu-backtest || echo "Check manually if needed"
          
          echo ""
          echo "âœ… Kernel submitted with GPU enabled!"
          echo "ğŸ”— View at: https://www.kaggle.com/code/${{ secrets.KAGGLE_USERNAME }}/freqai-gpu-backtest"
          echo ""
          echo "âš ï¸  IMPORTANT: If you see 'GPU not found' in the output:"
          echo "   1. Open the kernel link above"
          echo "   2. Click: Settings (âš™ï¸) â†’ Accelerator â†’ GPU T4"
          echo "   3. Click: Save & Run All"
      
      - name: ğŸ“ Create Summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ğŸš€ Kaggle GPU Backtest Triggered
          
          **â° Time:** $(date)
          **ğŸ® GPU:** Requested (T4/P100)
          **ğŸ“Š Params:** ${{ github.event.inputs.timerange || '20250101-20251012' }} | ${{ github.event.inputs.pairs || 'ALL' }}
          
          ### ğŸ”— Links:
          - [ğŸ“ˆ Kaggle Kernel](https://www.kaggle.com/code/${{ secrets.KAGGLE_USERNAME }}/freqai-gpu-backtest)
          - [ğŸ“œ Output](https://www.kaggle.com/code/${{ secrets.KAGGLE_USERNAME }}/freqai-gpu-backtest/output)
          
          ### âš™ï¸ Enable GPU Manually:
          If kernel shows "GPU not found":
          1. Open kernel â†’ Settings â†’ Accelerator â†’ **GPU T4**
          2. Save & Run All
          
          > ğŸ• GPU backtest: ~30-60 min | CPU: 2-3 hours
          EOF
