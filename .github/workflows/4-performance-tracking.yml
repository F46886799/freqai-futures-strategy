name: 4. Performance Tracking

on:
  push:
    branches: [ master ]
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:

jobs:
  performance-tracking:
    name: Track Strategy Performance
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for comparison
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy matplotlib seaborn
        pip install -r requirements.txt
        
    - name: Pull Freqtrade Docker Image
      run: |
        docker pull freqtradeorg/freqtrade:stable_freqairl
        
    - name: Download data for performance test
      run: |
        docker run --rm \
          -v ${{ github.workspace }}/user_data:/freqtrade/user_data \
          freqtradeorg/freqtrade:stable_freqairl \
          download-data \
          --exchange binance \
          --pairs BTC/USDT:USDT ETH/USDT:USDT SOL/USDT:USDT \
          --timeframes 5m 15m 1h \
          --days 180 \
          --trading-mode futures
      continue-on-error: true
        
    - name: Run performance backtest
      run: |
        # Get current date for timerange
        END_DATE=$(date +%Y%m%d)
        START_DATE=$(date -d '3 months ago' +%Y%m%d)
        
        docker run --rm \
          -v ${{ github.workspace }}/user_data:/freqtrade/user_data \
          -v ${{ github.workspace }}/config:/freqtrade/config \
          -v ${{ github.workspace }}/monitoring:/freqtrade/monitoring \
          freqtradeorg/freqtrade:stable_freqairl \
          backtesting \
          --strategy FreqAIHybridStrategy \
          --strategy-path /freqtrade/user_data/strategies \
          --config /freqtrade/config/config.json \
          --freqaimodel LightGBMRegressorMultiTarget \
          --timerange ${START_DATE}-${END_DATE} \
          --export trades \
          2>&1 | tee performance_output.txt
      continue-on-error: true
        
    - name: Extract and save metrics
      run: |
        python monitoring/extract_metrics.py performance_output.txt
      continue-on-error: true
        
    - name: Generate performance report
      run: |
        python monitoring/generate_report.py
      continue-on-error: true
        
    - name: Upload performance data
      uses: actions/upload-artifact@v4
      with:
        name: performance-tracking-${{ github.run_number }}
        path: |
          monitoring/metrics_history.csv
          monitoring/performance_report.html
          monitoring/charts/
        retention-days: 90
        
    - name: Create performance summary
      if: always()
      run: |
        echo "## ðŸ“ˆ Performance Tracking Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Tracking Information" >> $GITHUB_STEP_SUMMARY
        echo "- **Date:** $(date +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **Run Number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“Š Performance data has been collected and stored." >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¥ Download the full report from workflow artifacts." >> $GITHUB_STEP_SUMMARY
        
    - name: Compare with previous runs
      run: |
        echo "ðŸ“Š Comparing performance with previous runs..."
        python monitoring/compare_versions.py
      continue-on-error: true
